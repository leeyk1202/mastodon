run.config:
  engine: ruby
  engine.config:
    runtime: ruby-2.3.1

  extra_packages:
    # basic servers:
    - nginx
    - nodejs

    # for images:
    - ImageMagick

    # for videos:
    - ffmpeg3

    # to prep the .env file
    - gettext-tools

  cache_dirs:
    - node_modules

  extra_path_dirs:
    - node_modules/.bin

  build_triggers:
    - .ruby-version
    - Gemfile
    - Gemfile.lock
    - package.json
    - yarn.lock

  extra_steps:
    - cp .env.nanobox .env
    - gem install bundler
    - bundle config build.nokogiri --with-iconv-dir=/data/ --with-zlib-dir=/data/
    - bundle install
    - yarn

  fs_watch: true

deploy.config:
  extra_steps:
    - bundle exec rake assets:precompile
    - "[ -r /app/.env.production ] || sed 's/LOCAL_HTTPS=.*/LOCAL_HTTPS=true/i' /app/.env.nanobox > /app/.env.production"
  transform:
    - envsubst < /app/.env.production > /tmp/.env.production && mv /tmp/.env.production /app/.env.production
    - touch /app/log/production.log
  before_live:
    web.web:
      - bundle exec rake db:migrate:setup

web.web:
  start:
    nginx: nginx -c /app/nanobox/nginx-web.conf
    rails: bundle exec puma -C /app/config/puma.rb

  routes:
    - '/'

  writable_dirs:
    - tmp

  log_watch:
    rails: 'log/production.log'

  network_dirs:
    data.storage:
      - public/system

web.stream:
  start:
    nginx: nginx -c /app/nanobox/nginx-stream.conf
    node: yarn run start

  routes:
    - '/api/v1/streaming'

  writable_dirs:
    - tmp

worker.sidekiq:
  start: bundle exec sidekiq -c 5 -q default -q mailers -q pull -q push -L /app/log/sidekiq.log

  writable_dirs:
    - tmp

  log_watch:
    rails: 'log/production.log'
    sidekiq: 'log/sidekiq.log'

  network_dirs:
    data.storage:
      - public/system

  cron:
    - id: generate_static_gifs
      schedule: '*/15 * * * *'
      command: 'bundle exec rake mastodon:maintenance:add_static_avatars'
    - id: update_counter_caches
      schedule: '50 * * * *'
      command: 'bundle exec rake mastodon:maintenance:update_counter_caches'
    - id: clear_unassigned_media
      schedule: '0 0 * * *'
      command: 'bundle exec rake mastodon:media:clear'
    - id: clear_silenced_media
      schedule: '10 0 * * *'
      command: 'bundle exec rake mastodon:media:remove_silenced'
    - id: clear_unfollowed_subs
      schedule: '20 0 * * *'
      command: 'bundle exec rake mastodon:push:clear'
    - id: refresh_valid_subs
      schedule: '30 0 * * *'
      command: 'bundle exec rake mastodon:push:refresh'
    - id: clear_inactive_feeds
      schedule: '40 0 * * *'
      command: 'bundle exec rake mastodon:feeds:clear'
    - id: send_digest_emails
      schedule: '0 20 * * *'
      command: 'bundle exec rake mastodon:emails:digest'

data.db:
  image: nanobox/postgresql:9.5

data.redis:
  image: nanobox/redis:3.0

data.storage:
  image: nanobox/unfs:0.9
